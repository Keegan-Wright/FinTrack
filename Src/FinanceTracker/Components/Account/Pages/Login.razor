@page "/Account/Login"
@using Blazilla
@using FinanceTracker.Data.Models
@using FinanceTracker.Models.Request.Auth
@using FluentValidation
@using Microsoft.AspNetCore.Identity

@inject SignInManager<FinanceTrackerUser> SignInManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager
@inject IValidator<LoginRequest> Validator;

<PageTitle>Log in</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true" Align="Align.Center">Log in</MudText>

<EditForm Model="LoginRequest" method="post" OnValidSubmit="LoginUser" FormName="login">
    <FluentValidator/>

    <MudText GutterBottom="true" Typo="Typo.body1">Use a local account to log in.</MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudStaticTextField For="@(() => LoginRequest.Username)" @bind-Value="LoginRequest.Username"
                                Label="Username" Placeholder="Username"
                                UserAttributes="@(new Dictionary<string, object?> { { "autocomplete", "username" }, { "aria-required", "true" } })"/>
        </MudItem>
        <MudItem xs="12">
            <MudStaticTextField For="@(() => LoginRequest.Password)" @bind-Value="LoginRequest.Password"
                                Label="Password" InputType="InputType.Password" Placeholder="password"
                                UserAttributes="@(new Dictionary<string, object?> { { "autocomplete", "current-password" }, { "aria-required", "true" } })"/>
        </MudItem>
        <MudItem xs="12">
            <MudStaticCheckBox For="@(() => LoginRequest.RememberMe)" @bind-Value="LoginRequest.RememberMe">Remember
                me
            </MudStaticCheckBox>
        </MudItem>
        <MudItem xs="12">
            <MudStaticButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                             FormAction="FormAction.Submit">Log in
            </MudStaticButton>
        </MudItem>
    </MudGrid>
</EditForm>

@if (errorMessage is not null)
{
    <MudGrid Class="mt-4">
        <MudItem xs="12">
            <MudText Align="Align.Center" Color="Color.Error">@errorMessage</MudText>
        </MudItem>
    </MudGrid>
}

<MudGrid Class="mt-4">
    <MudItem xs="12">
        <MudLink Href="Account/ForgotPassword">Forgot your password?</MudLink>
        <br/>
        <MudLink
            Href="@(NavigationManager.GetUriWithQueryParameters("Account/Register", new Dictionary<string, object?> { ["ReturnUrl"] = ReturnUrl }))">
            Register as a new user
        </MudLink>
    </MudItem>
</MudGrid>

@code {
    private string? errorMessage;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm] private LoginRequest LoginRequest { get; set; } = new();

    [SupplyParameterFromQuery] private string? ReturnUrl { get; set; }

    public async Task LoginUser()
    {
        // This doesn't count login failures towards account lockout
        // To enable password failures to trigger account lockout, set lockoutOnFailure: true
        var result = await SignInManager.PasswordSignInAsync(LoginRequest.Username, LoginRequest.Password, LoginRequest.RememberMe, true);
        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in.");
            RedirectManager.RedirectTo(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out.");
            RedirectManager.RedirectTo("Account/Lockout");
        }
        else
        {
            errorMessage = "Invalid login attempt.";
        }
    }

}
