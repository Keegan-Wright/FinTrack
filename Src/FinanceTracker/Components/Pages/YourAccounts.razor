@page "/YourAccounts"
@using FinanceTracker.Enums
@using FinanceTracker.Models.Response.Account
@using FinanceTracker.Services.Account
@using Microsoft.AspNetCore.Authorization
@inherits PageComponent

@attribute [Authorize]
@inject IAccountService AccountService

<PageTitle>Accounts</PageTitle>
<MudGrid Class="my-2">
            @foreach (var account in _accounts)
            {
                <MudItem xs="12" md="12" lg="6" xl="4" Class="d-flex">
                    
                    <MudCard Elevation="1">
                        <MudCardContent Class="my-2">
                            
                            <MudGrid>
                                <MudItem xs="1">
                                    <MudImage Fluid="true" Width="80"
                                              Src="@($"data:image/svg+xml;base64, {Convert.ToBase64String(account.Logo)}")"></MudImage>
                                </MudItem>
                                <MudItem xs="11">
                                    <MudText Typo="Typo.h6">
                                        @account.AccountName
                                    </MudText>
                                    <MudText Typo="Typo.caption">
                                        @account.AccountType
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudGrid Justify="Justify.Center">
                                        <MudItem>
                                            <MudStack Spacing="10" Row="true">
                                                <MudStack AlignItems="AlignItems.Center">
                                                    <MudText>Current Balance</MudText>
                                                    <MudText>@account.AccountBalance.ToString("c")</MudText>
                                                </MudStack>
                                                <MudStack AlignItems="AlignItems.Center">
                                                    <MudText>Available Balance</MudText>
                                                    <MudText>@account.AvailableBalance.ToString("c")</MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                                <MudItem sm="12">
                                    <MudDataGrid T="AccountTransactionResponse" Items="account.Transactions"
                                                 SortMode="SortMode.None"
                                                 Filterable="false"
                                                 Hideable="false"
                                                 Hover="true">
                                        <Columns>
                                            <PropertyColumn Property="x => x.Description" Title="Description"  />
                                            <PropertyColumn Format="c" Property="x => x.Amount" Title="Amount"  />
                                            <PropertyColumn Property="x => x.Time" Title="Time"  />
                                            <PropertyColumn Property="x => x.Status" Title="Status"  />
                                        </Columns>
                                    </MudDataGrid>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
@code {

    private readonly List<AccountAndTransactionsResponse> _accounts  = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SetLoadingState(true, "Loading your accounts");
        await foreach (var account in AccountService.GetAccountsAndMostRecentTransactionsAsync(5, SyncTypes.Account | SyncTypes.Balance | SyncTypes.Transactions, Cts.Token))
        {
            _accounts.Add(account);
        }
        SetLoadingState(false);
    }
}