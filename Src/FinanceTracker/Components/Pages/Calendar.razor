@page "/Calendar"
@using FinanceTracker.Models.Response.Calendar
@using FinanceTracker.Services.Calendar
@using Microsoft.AspNetCore.Authorization
@inherits PageComponent

@attribute [Authorize]
@inject ICalendarService CalendarService

<PageTitle>Accounts</PageTitle>

<MudGrid Spacing="4">
    <MudItem xs="4">
        <MudDatePicker bind-Date="_selectedMonthYear" DateChanged="@SelectedDateUpdatedAsync"></MudDatePicker>
    </MudItem>

    <MudFlexBreak/>

    @foreach (var calenderItem in _calendarItems)
    {
        <MudItem>
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.body1">@calenderItem.Date.ToShortDateString()</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudExpansionPanels>
                        <MudExpansionPanel Text="Transactions">
                            @foreach (var transaction in calenderItem.Transactions)
                            {
                                <MudText>@transaction.Description @transaction.Amount.ToString("C")</MudText>
                            }
                        </MudExpansionPanel>

                        <MudExpansionPanel Text="Goals">
                            @foreach (var goal in calenderItem.Goals)
                            {
                                <MudText>@goal.Name</MudText>
                            }
                        </MudExpansionPanel>

                        <MudExpansionPanel Text="Events">
                            @foreach (var userEvent in calenderItem.Events)
                            {
                            }
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudCardContent>
            </MudCard>
        </MudItem>
    }

</MudGrid>

@code {

    private readonly List<CalendarItemsResponse> _calendarItems = [];
    private DateTime _selectedMonthYear = DateTime.UtcNow;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadSelectedCalendarMonthAsync();
    }

    private async Task SelectedDateUpdatedAsync(DateTime? obj)
    {
        if (obj is null)
            return;

        _selectedMonthYear = obj.Value;
        await LoadSelectedCalendarMonthAsync();
    }

    private async Task LoadSelectedCalendarMonthAsync()
    {
        SetLoadingState(true, "Loading your calendar");
        await foreach (var monthItem in CalendarService.GetMonthItemsAsync(_selectedMonthYear.Month, _selectedMonthYear.Year, _cts.Token))
        {
            _calendarItems.Add(monthItem);
        }

        SetLoadingState(false);
    }

}
