@inherits LayoutBase
@implements IDisposable

@inject NavigationManager NavigationManager

<MudThemeProvider @ref="@_mudThemeProvider" Theme="_theme" @bind-IsDarkMode="_isDarkMode" DefaultScrollbar="true"/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar Elevation="@(_isDarkMode ? 0 : 1)">
        <MudStaticNavDrawerToggle DrawerId="nav-drawer" Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit"
                                  Edge="Edge.Start"/>
        <MudText Typo="Typo.h6" Color="Color.Primary" Class="ml-3 font-bold" Style="letter-spacing: 0.5px;">FinTrack
        </MudText>
        <MudSpacer/>
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit" OnClick="@DarkModeToggle"/>
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Style="align-self: auto;" Color="Color.Inherit">
            <MudMenuItem>
                <form action="Account/Logout" method="post">
                    <AntiforgeryToken/>
                    <input type="hidden" name="ReturnUrl"/>
                    <button type="submit" class="nav-link">
                        Logout
                    </button>
                </form>
            </MudMenuItem>
        </MudMenu>
    </MudAppBar>
    <MudDrawer id="nav-drawer" @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="0">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent Class="pt-16 pa-4 mt-4">
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
            <CascadingValue Value="@ApplicationState.Loading">
                <MudOverlay Visible="@ApplicationState.Loading" DarkBackground="@(_isDarkMode)"
                            LightBackground="@(!_isDarkMode)" AutoClose="false">
                    <MudItem Class="d-flex flex-column align-center">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                        <MudText Typo="Typo.h6">@ApplicationState.LoadingMessage</MudText>
                    </MudItem>
                </MudOverlay>
                @Body
            </CascadingValue>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {

    [CascadingParameter] public IHttpContextAccessor? HttpContext { get; set; }

    private void DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;
    }

    private async Task LogoutAsync()
    {
        NavigationManager.NavigateTo("Account/Login", true);
    }

    public void Dispose()
    {
        ApplicationState.PropertyChanged -= ApplicationStateOnPropertyChanged;
    }

}